---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header';
import Footer from '../../components/Footer';
import Button from '../../components/ui/Button';
import Configurator from '../../components/Configurator';
import { supabase } from '../../lib/supabase';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// 1. Fetch Current Vehicle
const { data: vehicle, error } = await supabase
  .from('veicoli')
  .select('*')
  .eq('slug', slug)
  .single();

if (error || !vehicle) {
  console.error('Vehicle not found:', error);
  return Astro.redirect('/404');
}

// 2. Fetch Related Vehicles (Simple Randomization for now)
const { data: relatedData } = await supabase
  .from('veicoli')
  .select('titolo, canone_mensile, immagine_url, slug, marca, modello, alimentazione, categoria')
  .neq('id', vehicle.id) // Exclude current
  .limit(10); // Fetch a pool

// Shuffle and pick 3
const relatedVehicles = relatedData
  ? relatedData.sort(() => 0.5 - Math.random()).slice(0, 3)
  : [];

// Formatting helpers
const formatCurrency = (val) => {
    return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val);
};

// Mock Features based on reference image structure
const INCLUDED_SERVICES = [
    { label: 'Manutenzione ordinaria e straordinaria', active: true },
    { label: 'Assicurazione RCAuto', active: true },
    { label: 'Assicurazione Incendio e Furto', active: true },
    { label: 'Assicurazione Kasco Full', active: true },
    { label: 'Assicurazione Eventi Naturali', active: true },
    { label: 'Assicurazione Atti Vandalici', active: true },
    { label: 'Assicurazione Cristalli', active: true },
    { label: 'Assistenza Stradale 24/7', active: true },
    { label: 'Gestione pagamento Bollo - Tasse - Multe', active: true },
    { label: 'Consegna a domicilio', active: true },
    { label: 'Vettura in pre-assegnazione', active: true },
];

const SPECS = [
    { icon: 'category', label: 'Categoria', value: vehicle.categoria },
    { icon: 'fuel', label: 'Alimentazione', value: vehicle.alimentazione },
    { icon: 'transmission', label: 'Cambio', value: vehicle.cambio },
];
---

<Layout title={`${vehicle.titolo} | Noleggio Lungo Termine`}>
    <Header client:load />

    <main class="bg-gray-50 min-h-screen pb-20 pt-8">
        <div class="container-custom">
            
            {/* BREADCRUMB REMOVED */}

            <div class="flex flex-col lg:flex-row gap-8 lg:gap-16">
                
                {/* LEFT SIDEBAR (CONFIGURATOR & SPECS) */}
                <div class="w-full lg:w-1/3 order-2 lg:order-1 space-y-8">
                    
                    {/* CONFIGURATOR CARD COMPONENT */}
                    <Configurator 
                        client:load
                        basePrice={vehicle.canone_mensile || 0}
                        initialMonths={vehicle.durata_mesi || 36}
                        initialDistance={vehicle.km_annui || '15.000'}
                        vehicleTitle={`${vehicle.marca} ${vehicle.modello}`}
                        vehicleVersion={vehicle.versione}
                        image={vehicle.immagine_url}
                    />

                    {/* SPECS LIST */}
                    <div class="bg-white rounded-[20px] p-6 shadow-soft border border-gray-100">
                        <h4 class="font-bold text-gray-800 mb-4 pb-2 border-b border-gray-50">Caratteristiche del <span class="text-primary">Veicolo</span></h4>
                        <div class="grid grid-cols-2 gap-y-4 gap-x-2">
                             {SPECS.map(spec => (
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-400 mb-1 flex items-center gap-1.5">
                                        {spec.icon === 'category' && <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>}
                                        {spec.icon === 'fuel' && <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.77 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>}
                                        {spec.icon === 'transmission' && <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>}
                                        {spec.label}
                                    </span>
                                    <span class="font-bold text-primary text-sm">{spec.value || 'N/D'}</span>
                                </div>
                             ))}
                        </div>
                    </div>

                    {/* INCLUDED SERVICES */}
                    <div class="bg-white rounded-[20px] p-6 shadow-soft border border-gray-100">
                        <h4 class="font-bold text-gray-800 mb-4 pb-2 border-b border-gray-50">Servizi inclusi nel <span class="text-primary">Canone</span></h4>
                        <ul class="space-y-3">
                            {INCLUDED_SERVICES.map(service => (
                                <li class="flex items-start gap-3 group">
                                    <div class="mt-0.5 w-5 h-5 rounded-full bg-primary/10 text-primary flex items-center justify-center flex-shrink-0 group-hover:bg-primary group-hover:text-white transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                    </div>
                                    <span class="text-sm text-gray-600 leading-snug">{service.label}</span>
                                </li>
                            ))}
                        </ul>
                    </div>

                </div>

                {/* RIGHT MAIN CONTENT (IMAGE & HEADER) */}
                <div class="w-full lg:w-2/3 order-1 lg:order-2">
                    
                    {/* VEHICLE CARD (HERO) */}
                    <div class="bg-white rounded-[30px] p-6 md:p-10 shadow-soft border border-gray-100 mb-12 relative overflow-hidden group">
                        
                        {/* Image */}
                        <div class="relative w-full aspect-[16/10] md:aspect-[2/1] mb-8 flex items-center justify-center">
                            <img 
                                src={vehicle.immagine_url || 'https://via.placeholder.com/800x600?text=No+Image'} 
                                alt={vehicle.titolo} 
                                class="w-full h-full object-contain transform group-hover:scale-105 transition-transform duration-500"
                            />
                        </div>

                        {/* Header Info */}
                        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 border-t border-gray-100 pt-8">
                            <div>
                                <h1 class="font-heading font-extrabold text-3xl md:text-5xl text-primary mb-2 leading-tight">
                                    {vehicle.marca} <br/>
                                    <span class="text-secondary">{vehicle.modello}</span>
                                </h1>
                                <p class="text-gray-400 font-medium text-lg">{vehicle.versione}</p>
                            </div>

                            <div class="text-right">
                                <p class="text-gray-400 text-sm mb-1 font-medium">Canone a partire da:</p>
                                <div class="flex items-baseline justify-end gap-1">
                                    <span class="font-heading font-extrabold text-4xl md:text-5xl text-secondary">{vehicle.canone_mensile ? Math.floor(vehicle.canone_mensile) : 'N/D'}€</span>
                                    <span class="text-gray-400 font-medium">/ mese i.e.</span>
                                </div>
                                <p class="text-xs text-gray-300 mt-1">Anticipo: {formatCurrency(vehicle.anticipo)}</p>
                            </div>
                        </div>

                        {/* OPTIONAL BANNER */}
                        <div class="mt-8 bg-gray-50 rounded-xl py-3 px-6 flex items-center justify-center gap-3 text-gray-600 font-bold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            Optional Inclusi
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                    </div>

                    {/* RELATED VEHICLES */}
                    <div class="space-y-6">
                        <h3 class="text-primary font-bold text-lg uppercase tracking-widest mb-6">Potrebbe piacerti anche:</h3>
                        
                        <div class="grid gap-6">
                            {relatedVehicles.map(related => (
                                <a href={`/veicoli/${related.slug}`} class="bg-white rounded-[20px] p-6 border border-gray-100 shadow-sm hover:shadow-xl transition-all hover:-translate-y-1 flex flex-col md:flex-row items-center gap-6 group">
                                    
                                    <div class="w-full md:w-1/3 aspect-[4/3] overflow-hidden rounded-xl bg-gray-50 flex items-center justify-center">
                                         <img 
                                            src={related.immagine_url} 
                                            alt={related.titolo} 
                                            class="w-full h-full object-contain mix-blend-multiply p-2 group-hover:scale-110 transition-transform duration-500"
                                        />
                                    </div>
                                    
                                    <div class="flex-grow w-full md:w-auto text-center md:text-left">
                                        <div class="flex md:flex-col gap-2 mb-2 items-center md:items-start justify-center">
                                            <h4 class="font-heading font-bold text-xl text-primary">
                                                <span class="text-secondary">{related.marca}</span> {related.modello}
                                            </h4>
                                            <span class="bg-primary/10 text-primary text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider">{related.categoria || 'SUV'}</span>
                                        </div>
                                        <p class="text-gray-400 text-sm mb-4 line-clamp-1">{related.titolo}</p>
                                        
                                        <div class="flex items-center justify-center md:justify-start gap-4">
                                            <div class="border border-gray-200 rounded-lg px-3 py-1 text-xs font-semibold text-gray-500">
                                                {related.alimentazione}
                                            </div>
                                            <div class="text-primary font-bold">
                                                 {related.canone_mensile}€ <span class="text-gray-400 text-xs font-normal">/mese</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="hidden md:block">
                                        <div class="w-10 h-10 rounded-full border-2 border-primary/10 flex items-center justify-center text-primary group-hover:bg-secondary group-hover:border-secondary group-hover:text-white transition-all">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                                        </div>
                                    </div>
                                </a>
                            ))}
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <Footer />
</Layout>
