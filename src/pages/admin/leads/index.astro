---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { createClient } from "@supabase/supabase-js";

// Redirect if not authenticated (Basic check, middleware handles mostly)
if (!Astro.locals.user) {
    return Astro.redirect("/admin/login");
}

// Instantiate Admin Client (Server-Side Only) to bypass RLS
const supabaseAdmin = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_SERVICE_ROLE_KEY ||
        process.env.SUPABASE_SERVICE_ROLE_KEY,
);

// 1. Get Filters from URL
const filterType = Astro.url.searchParams.get("type") || "all";

// 2. Fetch All Leads using Admin Client
const { data: rawLeads, error } = await supabaseAdmin
    .from("leads")
    .select("*")
    .order("created_at", { ascending: false });

if (error) {
    console.error("Error fetching leads:", error);
}

// 3. Helper to determine Lead Type
const getLeadType = (lead: any) => {
    const title = lead.vehicle_snapshot?.title || "";
    const config = lead.configuration || {};

    if (title === "VALUTAZIONE USATO") return "acquisto";
    if (config.type === "luxury" || config.type === "LUXURY_REQUEST")
        return "luxury"; // New Luxury Logic
    if (config.plan) return "breve"; // Short term rental has 'plan' in configuration
    if ((!title || title.trim() === "") && Object.keys(config).length === 0)
        return "contatto"; // No vehicle, no config = General Contact

    // Default fallback to Long Term
    return "lungo";
};

// 4. Process and Filter Leads
const allLeads = (rawLeads || []).map((lead) => ({
    ...lead,
    computedType: getLeadType(lead),
}));

const filteredLeads =
    filterType === "all"
        ? allLeads
        : allLeads.filter((lead) => lead.computedType === filterType);

// UI Helpers
const getTypeBadge = (type: string) => {
    switch (type) {
        case "lungo":
            return '<span class="px-2 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-bold">Lungo Termine</span>';
        case "breve":
            return '<span class="px-2 py-1 rounded-full bg-purple-100 text-purple-800 text-xs font-bold">Noleggio Breve</span>';
        case "luxury":
            return '<span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold border border-yellow-200">Luxury Collection</span>';
        case "acquisto":
            return '<span class="px-2 py-1 rounded-full bg-orange-100 text-orange-800 text-xs font-bold">Valutazione</span>';
        case "contatto":
            return '<span class="px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-xs font-bold">Contatto</span>';
        default:
            return '<span class="px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-xs font-bold">Altro</span>';
    }
};

const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleString("it-IT", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
    });
};
---

<AdminLayout title="Richieste">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Richieste Ricevute</h1>
            <p class="text-gray-500">
                Gestisci i messaggi e le richieste di preventivo.
            </p>
        </div>

        <!-- FILTER DROPDOWN -->
        <div class="relative">
            <select
                class="appearance-none bg-white border border-gray-200 text-gray-700 py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-primary cursor-pointer shadow-sm font-medium"
                onchange="window.location.href=`?type=${this.value}`"
            >
                <option value="all" selected={filterType === "all"}
                    >Tutte le Richieste</option
                >
                <option value="lungo" selected={filterType === "lungo"}
                    >Noleggio Lungo Termine</option
                >
                <option value="breve" selected={filterType === "breve"}
                    >Noleggio Breve</option
                >
                <option value="luxury" selected={filterType === "luxury"}
                    >Luxury Collection</option
                >
                <option value="acquisto" selected={filterType === "acquisto"}
                    >Acquisto Auto</option
                >
                <option value="contatto" selected={filterType === "contatto"}
                    >Contatti Generici</option
                >
            </select>
            <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"
            >
                <svg
                    class="fill-current h-4 w-4"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    ><path
                        d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                    ></path></svg
                >
            </div>
        </div>
    </div>

    <!-- DATA TABLE -->
    <div
        class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
    >
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr
                        class="bg-gray-50 border-b border-gray-100 text-xs uppercase text-gray-500 font-semibold tracking-wider"
                    >
                        <th class="p-4">Data</th>
                        <th class="p-4">Tipo</th>
                        <th class="p-4">Utente</th>
                        <th class="p-4">Detagli Richiesta</th>
                        <th class="p-4 text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {
                        filteredLeads.length > 0 ? (
                            filteredLeads.map((lead) => (
                                <tr class="hover:bg-gray-50 transition-colors group">
                                    <td class="p-4 text-sm text-gray-500 whitespace-nowrap">
                                        {formatDate(lead.created_at)}
                                    </td>
                                    <td class="p-4">
                                        <Fragment
                                            set:html={getTypeBadge(
                                                lead.computedType,
                                            )}
                                        />
                                    </td>
                                    <td class="p-4">
                                        <div class="flex flex-col">
                                            <span class="font-bold text-gray-800">
                                                {lead.full_name}
                                            </span>
                                            <span class="text-sm text-gray-500">
                                                {lead.email}
                                            </span>
                                            <span class="text-xs text-gray-400">
                                                {lead.phone}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="p-4">
                                        <div class="max-w-xs">
                                            {lead.vehicle_snapshot?.title && (
                                                <div class="font-bold text-primary text-sm mb-1">
                                                    {
                                                        lead.vehicle_snapshot
                                                            .title
                                                    }
                                                    <span class="font-normal text-gray-600">
                                                        {
                                                            lead
                                                                .vehicle_snapshot
                                                                .version
                                                        }
                                                    </span>
                                                </div>
                                            )}

                                            {/* Configuration Details (if any) */}
                                            {lead.configuration &&
                                                Object.keys(lead.configuration)
                                                    .length > 0 && (
                                                    <div class="text-xs text-gray-500 bg-gray-50 p-1.5 rounded border border-gray-100 inline-block mb-1">
                                                        {lead.configuration
                                                            .months
                                                            ? `${lead.configuration.months} Mesi`
                                                            : ""}
                                                        {lead.configuration.km
                                                            ? ` / ${lead.configuration.km} Km`
                                                            : ""}
                                                        {lead.configuration.plan
                                                            ? `Piano: ${lead.configuration.plan}`
                                                            : ""}
                                                    </div>
                                                )}

                                            {/* Message Preview */}
                                            {lead.message && (
                                                <p
                                                    class="text-sm text-gray-600 italic line-clamp-2"
                                                    title={lead.message}
                                                >
                                                    "{lead.message}"
                                                </p>
                                            )}
                                        </div>
                                    </td>
                                    <td class="p-4 text-center">
                                        <a
                                            href={`mailto:${lead.email}`}
                                            class="text-gray-400 hover:text-primary transition-colors p-2 inline-block rounded-full hover:bg-primary/5"
                                            title="Invia Email"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                width="18"
                                                height="18"
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                            >
                                                <>
                                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                                    <polyline points="22,6 12,13 2,6" />
                                                </>
                                            </svg>
                                        </a>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td
                                    colspan="5"
                                    class="p-8 text-center text-gray-400"
                                >
                                    <div class="flex flex-col items-center justify-center">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="48"
                                            height="48"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="1"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="mb-4 opacity-50"
                                        >
                                            <>
                                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                                <polyline points="22,6 12,13 2,6" />
                                            </>
                                        </svg>
                                        <p>Nessuna richiesta trovata.</p>
                                    </div>
                                </td>
                            </tr>
                        )
                    }
                </tbody>
            </table>
        </div>
    </div>
</AdminLayout>
